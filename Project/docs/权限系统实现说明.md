# 权限系统实现说明

## 概述

本文档说明了团队知识库管理系统中基础权限系统的完整实现，包括后端权限中间件、前端权限管理 Hook 和使用示例。

## 权限逻辑设计

### 角色系统
- **admin（管理员）**: 拥有所有权限，可以管理所有文档
- **editor（编辑者）**: 可以编辑和管理自己的文档
- **viewer（查看者）**: 只能查看公开文档

### 文档权限规则
1. **文档创建者**: 拥有文档的全权限（查看、编辑、删除）
2. **公开文档** (`is_public=1`): 任何用户可查看和下载
3. **私有文档** (`is_public=0`): 仅创建者和管理员可访问
4. **管理员角色**: 可管理所有文档

## 后端实现

### 1. 权限中间件 (`backend/src/middleware/permission.ts`)

```typescript
// 基础认证中间件
export const requireAuth = (req, res, next) => {
  // 验证用户是否已登录
}

// 角色权限检查
export const requireRole = (allowedRoles: string[]) => {
  // 验证用户是否拥有指定角色
}

// 文档访问权限检查
export const checkDocumentAccess = async (req, res, next) => {
  // 验证用户是否可以访问指定文档
}

// 文档编辑权限检查
export const checkDocumentEditAccess = async (req, res, next) => {
  // 验证用户是否可以编辑指定文档
}
```

### 2. 角色模型 (`backend/src/models/Role.ts`)

```typescript
export interface Role {
  id: number;
  name: string;
  description: string;
  permissions: string;
}

export class RoleModel {
  static async findById(id: number): Promise<Role | null>
  static async findByName(name: string): Promise<Role | null>
  static hasPermission(role: Role, permission: string): boolean
}
```

### 3. 用户模型增强 (`backend/src/models/User.ts`)

```typescript
export interface UserProfile {
  // 添加了 role 字段
  role?: string;
}

export class UserModel {
  // 新增方法：获取包含角色信息的用户资料
  static async toProfileWithRole(user: User): Promise<UserProfile>
}
```

### 4. 认证路由更新 (`backend/src/routes/auth.ts`)

- JWT Token 中包含角色信息
- 登录和注册时返回用户角色
- 获取用户信息时包含角色

## 前端实现

### 1. 权限 Hook (`frontend/src/hooks/usePermission.ts`)

```typescript
export const usePermission = () => {
  return {
    // 角色检查
    hasRole: (role: string) => boolean,
    isAdmin: () => boolean,
    isEditor: () => boolean,
    
    // 文档权限检查
    canViewDocument: (document: Document) => boolean,
    canEditDocument: (document: Document) => boolean,
    canDeleteDocument: (document: Document) => boolean,
    canDownloadDocument: (document: Document) => boolean,
    canUploadDocument: () => boolean,
    canManageDocuments: () => boolean,
    canChangeDocumentPermission: (document: Document) => boolean,
    
    // 综合权限获取
    getDocumentPermissions: (document: Document) => PermissionSummary,
    
    // 当前用户信息
    currentUser: User | null,
    isAuthenticated: boolean,
  };
};
```

### 2. 组件权限集成

#### DocumentActions 组件
```typescript
const DocumentActions = ({ document }) => {
  const { canEditDocument, canDeleteDocument } = usePermission();
  
  const canEdit = canEditDocument(document);
  const canDelete = canDeleteDocument(document);
  
  return (
    <Space>
      {canEdit && <Button>编辑</Button>}
      {canDelete && <Button>删除</Button>}
    </Space>
  );
};
```

#### DocumentDetailPage 页面
```typescript
const DocumentDetailPage = () => {
  const { canViewDocument, getDocumentPermissions } = usePermission();
  
  const canView = canViewDocument(document);
  const permissions = getDocumentPermissions(document);
  
  if (!canView) {
    return <Alert message="无权限访问" type="error" />;
  }
  
  // 渲染文档详情
};
```

## 使用示例

### 1. 路由权限控制

```typescript
import { requireAuth, requireRole } from '../middleware/permission';

// 需要登录
router.post('/documents', requireAuth, uploadDocument);

// 需要管理员权限
router.get('/admin/users', requireAuth, requireRole(['admin']), getUsers);

// 需要编辑者或管理员权限
router.put('/documents/:id', requireAuth, requireRole(['admin', 'editor']), updateDocument);
```

### 2. 文档操作权限

```typescript
// 文档访问（支持匿名访问公开文档）
router.get('/documents/:id', optionalAuth, checkDocumentAccess, getDocument);

// 文档下载（支持匿名下载公开文档）
router.get('/documents/:id/download', optionalAuth, checkDocumentAccess, downloadDocument);

// 文档编辑（仅创建者和管理员）
router.put('/documents/:id', requireAuth, checkDocumentEditAccess, updateDocument);

// 文档删除（仅创建者和管理员）
router.delete('/documents/:id', requireAuth, checkDocumentEditAccess, deleteDocument);
```

### 3. 前端权限检查

```typescript
const MyComponent = () => {
  const { 
    hasRole, 
    canEditDocument, 
    canDeleteDocument, 
    getDocumentPermissions 
  } = usePermission();
  
  // 角色检查
  const isAdmin = hasRole('admin');
  const isEditor = hasRole('editor');
  
  // 文档权限检查
  const canEdit = canEditDocument(document);
  const canDelete = canDeleteDocument(document);
  
  // 获取完整权限信息
  const permissions = getDocumentPermissions(document);
  
  return (
    <div>
      {isAdmin && <AdminPanel />}
      {canEdit && <EditButton />}
      {canDelete && <DeleteButton />}
      {permissions.isOwner && <OwnerActions />}
    </div>
  );
};
```

## 权限验证流程

### 1. 后端验证流程
1. 用户发送请求携带 JWT Token
2. `requireAuth` 中间件验证 Token 有效性
3. `requireRole` 中间件检查用户角色
4. `checkDocumentAccess` 中间件验证文档访问权限
5. 业务逻辑处理请求

### 2. 前端验证流程
1. 用户登录获取包含角色信息的 Token
2. AuthContext 存储用户信息和角色
3. usePermission Hook 基于用户角色和文档信息计算权限
4. 组件根据权限控制 UI 显示

## 安全性考虑

1. **后端验证为主**: 前端权限检查仅用于 UI 控制，真正的权限验证在后端进行
2. **JWT 安全**: Token 包含用户角色信息，避免频繁数据库查询
3. **权限最小化**: 默认权限最小，明确授权才能访问
4. **角色分离**: 不同角色拥有不同的权限范围

## 测试建议

1. **单元测试**: 测试权限 Hook 的各种权限判断逻辑
2. **集成测试**: 测试权限中间件在不同场景下的行为
3. **端到端测试**: 测试完整的权限验证流程
4. **安全测试**: 尝试绕过权限限制的攻击测试

## 扩展性

权限系统设计支持以下扩展：

1. **细粒度权限**: 可以扩展为基于资源的细粒度权限控制
2. **动态角色**: 支持运行时动态分配和修改角色
3. **权限继承**: 支持角色权限的继承关系
4. **临时权限**: 支持时限性的临时权限授予

此权限系统为团队知识库提供了基础而完善的访问控制机制，确保文档安全的同时提供良好的用户体验。