# 团队知识库管理工具 - 架构设计文档

## 1. 架构概述

### 1.1 设计原则
- **分层架构**: 采用经典三层架构模式，职责分离清晰
- **松耦合**: 各层之间通过接口通信，降低耦合度
- **可扩展性**: 模块化设计，便于功能扩展和维护
- **安全性**: 多层次安全防护机制
- **性能优化**: 合理的缓存策略和数据库优化

### 1.2 技术选型
- **前端**: React 18 + TypeScript + Ant Design + Vite
- **后端**: Node.js + Express + TypeScript + JWT
- **数据库**: SQLite 3.x
- **文件存储**: 本地文件系统
- **构建工具**: Vite (前端) + tsc (后端)
- **代码质量**: ESLint + Prettier + Husky

## 2. 总体架构

### 2.1 系统架构图
```
┌─────────────────────────────────────────────────────┐
│                   浏览器客户端                       │
│            (Chrome/Firefox/Safari)                │
└─────────────────┬───────────────────────────────────┘
                  │ HTTPS/HTTP
                  │ (端口: 3000)
┌─────────────────▼───────────────────────────────────┐
│                前端应用层                           │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │
│ │   页面组件   │ │   业务组件   │ │   公共组件   │    │
│ └─────────────┘ └─────────────┘ └─────────────┘    │
│ ┌─────────────────────────────────────────────────┐ │
│ │            状态管理 (Context/Redux)              │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │              HTTP客户端 (Axios)                 │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────────────────┘
                  │ REST API
                  │ (端口: 8000)
┌─────────────────▼───────────────────────────────────┐
│                API网关层                            │
│ ┌─────────────────────────────────────────────────┐ │
│ │    认证中间件 │ 权限中间件 │ 日志中间件 │ 错误处理  │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│                业务逻辑层                           │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │
│ │   用户服务   │ │   文档服务   │ │   搜索服务   │    │
│ └─────────────┘ └─────────────┘ └─────────────┘    │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │
│ │   标签服务   │ │   权限服务   │ │   文件服务   │    │
│ └─────────────┘ └─────────────┘ └─────────────┘    │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│                数据访问层                           │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │
│ │   用户DAO    │ │   文档DAO    │ │   标签DAO    │    │
│ └─────────────┘ └─────────────┘ └─────────────┘    │
│ ┌─────────────────────────────────────────────────┐ │
│ │              数据库连接池                        │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────────────────┘
                  │ SQL
┌─────────────────▼───────────────────────────────────┐
│                数据存储层                           │
│ ┌─────────────┐     ┌─────────────────────────────┐ │
│ │ SQLite数据库 │     │        文件系统              │ │
│ │             │     │ ┌─────────┐ ┌─────────────┐ │ │
│ │ 结构化数据   │     │ │ 上传文件 │ │   缩略图     │ │ │
│ │             │     │ └─────────┘ └─────────────┘ │ │
│ └─────────────┘     └─────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 2.2 部署架构图
```
┌─────────────────────────────────────────────────────┐
│                   生产环境                          │
│ ┌─────────────┐                 ┌─────────────────┐ │
│ │    Nginx    │────────────────►│   静态文件服务   │ │
│ │  (反向代理)  │                 │   (前端资源)     │ │
│ │   端口:80   │                 └─────────────────┘ │
│ └──────┬──────┘                                     │
│        │                                           │
│        ▼                                           │
│ ┌─────────────┐     ┌─────────────┐               │
│ │ Node.js服务  │────►│   SQLite    │               │
│ │   端口:8000  │     │    数据库    │               │
│ │    (PM2)    │     └─────────────┘               │
│ └─────────────┘                                    │
│        │                                           │
│        ▼                                           │
│ ┌─────────────────────────────────────────────────┐ │
│ │              本地文件系统                        │ │
│ │  /uploads/documents/  |  /uploads/thumbnails/   │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

## 3. 前端架构设计

### 3.1 目录结构
```
frontend/
├── public/                    # 静态资源
│   ├── index.html
│   └── favicon.ico
├── src/
│   ├── components/            # 公共组件
│   │   ├── Layout/           # 布局组件
│   │   ├── Upload/           # 上传组件
│   │   ├── Search/           # 搜索组件
│   │   └── Common/           # 通用组件
│   ├── pages/                # 页面组件
│   │   ├── Auth/             # 认证页面
│   │   ├── Dashboard/        # 仪表板
│   │   ├── Documents/        # 文档管理
│   │   ├── Tags/             # 标签管理
│   │   └── Settings/         # 设置页面
│   ├── hooks/                # 自定义Hook
│   │   ├── useAuth.ts
│   │   ├── useDocuments.ts
│   │   └── useSearch.ts
│   ├── services/             # API服务
│   │   ├── api.ts            # API基础配置
│   │   ├── auth.ts           # 认证服务
│   │   ├── documents.ts      # 文档服务
│   │   └── tags.ts           # 标签服务
│   ├── store/                # 状态管理
│   │   ├── authContext.tsx   # 认证状态
│   │   ├── appContext.tsx    # 应用状态
│   │   └── types.ts          # 状态类型
│   ├── utils/                # 工具函数
│   │   ├── request.ts        # 请求封装
│   │   ├── storage.ts        # 本地存储
│   │   └── helpers.ts        # 辅助函数
│   ├── types/                # TypeScript类型
│   │   ├── api.ts            # API类型
│   │   ├── user.ts           # 用户类型
│   │   └── document.ts       # 文档类型
│   ├── styles/               # 样式文件
│   │   ├── global.css
│   │   └── variables.css
│   └── App.tsx
├── package.json
├── vite.config.ts
└── tsconfig.json
```

### 3.2 组件设计原则
- **单一职责**: 每个组件只负责一个功能
- **可复用性**: 通过props实现组件的灵活配置
- **类型安全**: 完整的TypeScript类型定义
- **性能优化**: 使用React.memo和useMemo优化渲染

### 3.3 状态管理架构
```typescript
// 认证状态管理
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

// 应用状态管理
interface AppState {
  theme: 'light' | 'dark';
  language: 'zh' | 'en';
  sidebarCollapsed: boolean;
}
```

### 3.4 路由设计
```typescript
const routes = [
  {
    path: '/',
    element: <Layout />,
    children: [
      { path: 'dashboard', element: <Dashboard /> },
      { path: 'documents', element: <Documents /> },
      { path: 'documents/:id', element: <DocumentDetail /> },
      { path: 'tags', element: <Tags /> },
      { path: 'search', element: <Search /> },
      { path: 'settings', element: <Settings /> }
    ]
  },
  { path: '/login', element: <Login /> },
  { path: '/register', element: <Register /> }
];
```

## 4. 后端架构设计

### 4.1 目录结构
```
backend/
├── src/
│   ├── controllers/          # 控制器层
│   │   ├── authController.ts
│   │   ├── userController.ts
│   │   ├── documentController.ts
│   │   ├── tagController.ts
│   │   └── searchController.ts
│   ├── services/             # 业务逻辑层
│   │   ├── authService.ts
│   │   ├── userService.ts
│   │   ├── documentService.ts
│   │   ├── tagService.ts
│   │   ├── searchService.ts
│   │   └── fileService.ts
│   ├── models/               # 数据模型
│   │   ├── User.ts
│   │   ├── Document.ts
│   │   ├── Tag.ts
│   │   └── Permission.ts
│   ├── dao/                  # 数据访问层
│   │   ├── userDao.ts
│   │   ├── documentDao.ts
│   │   ├── tagDao.ts
│   │   └── permissionDao.ts
│   ├── middleware/           # 中间件
│   │   ├── auth.ts           # 认证中间件
│   │   ├── permission.ts     # 权限中间件
│   │   ├── upload.ts         # 文件上传中间件
│   │   ├── validation.ts     # 参数验证中间件
│   │   └── errorHandler.ts   # 错误处理中间件
│   ├── routes/               # 路由定义
│   │   ├── authRoutes.ts
│   │   ├── userRoutes.ts
│   │   ├── documentRoutes.ts
│   │   ├── tagRoutes.ts
│   │   └── searchRoutes.ts
│   ├── utils/                # 工具函数
│   │   ├── database.ts       # 数据库连接
│   │   ├── jwt.ts            # JWT工具
│   │   ├── crypto.ts         # 加密工具
│   │   ├── logger.ts         # 日志工具
│   │   └── validator.ts      # 验证工具
│   ├── config/               # 配置文件
│   │   ├── database.ts
│   │   ├── app.ts
│   │   └── constants.ts
│   └── app.ts                # 应用入口
├── uploads/                  # 文件上传目录
│   ├── documents/
│   ├── thumbnails/
│   └── avatars/
├── database/                 # 数据库文件
│   └── knowledge_base.db
├── logs/                     # 日志文件
├── package.json
└── tsconfig.json
```

### 4.2 分层架构详解

#### 4.2.1 控制器层 (Controllers)
负责处理HTTP请求和响应，参数验证，调用业务逻辑层
```typescript
class DocumentController {
  async upload(req: Request, res: Response) {
    // 1. 参数验证
    // 2. 调用服务层
    // 3. 返回响应
  }
}
```

#### 4.2.2 业务逻辑层 (Services)
包含核心业务逻辑，事务处理，权限验证
```typescript
class DocumentService {
  async uploadDocument(file: File, metadata: DocumentMetadata, userId: number) {
    // 1. 文件处理
    // 2. 生成缩略图
    // 3. 保存到数据库
    // 4. 更新索引
  }
}
```

#### 4.2.3 数据访问层 (DAO)
负责数据库操作，SQL查询封装
```typescript
class DocumentDao {
  async create(document: Document): Promise<Document> {
    // SQL 执行
  }
  
  async findById(id: number): Promise<Document | null> {
    // SQL 执行
  }
}
```

### 4.3 中间件架构
```typescript
// 认证中间件
const authMiddleware = (req: Request, res: Response, next: NextFunction) => {
  // JWT验证逻辑
};

// 权限中间件
const permissionMiddleware = (requiredPermission: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    // 权限验证逻辑
  };
};
```

## 5. 数据库架构

### 5.1 数据库设计模式
- **规范化设计**: 第三范式，减少数据冗余
- **索引策略**: 为查询频繁的字段建立索引
- **外键约束**: 保证数据完整性
- **事务支持**: 关键操作使用事务

### 5.2 连接池管理
```typescript
class DatabaseManager {
  private static instance: Database;
  
  static getInstance(): Database {
    if (!this.instance) {
      this.instance = new sqlite3.Database(DB_PATH);
    }
    return this.instance;
  }
}
```

## 6. 安全架构

### 6.1 认证机制
- **JWT Token**: 无状态认证
- **刷新Token**: 长期会话管理
- **密码加密**: bcrypt哈希加密
- **会话管理**: Token过期和刷新

### 6.2 权限控制
```
用户 ──► 角色 ──► 权限
  │              │
  └──────────────┴─► 资源访问
```

### 6.3 安全防护
- **SQL注入防护**: 参数化查询
- **XSS防护**: 输入过滤和输出编码
- **CSRF防护**: Token验证
- **文件上传安全**: 类型验证和病毒扫描

## 7. 性能架构

### 7.1 前端性能优化
- **代码分割**: React.lazy + Suspense
- **资源优化**: 图片压缩、懒加载
- **缓存策略**: HTTP缓存、浏览器缓存
- **打包优化**: Tree shaking、压缩

### 7.2 后端性能优化
- **数据库优化**: 索引优化、查询优化
- **缓存机制**: 内存缓存、文件缓存
- **压缩传输**: Gzip压缩
- **异步处理**: 异步I/O操作

### 7.3 文件处理优化
- **流式上传**: 大文件分块上传
- **缩略图生成**: 异步生成和缓存
- **CDN集成**: 静态资源CDN分发

## 8. 监控和日志架构

### 8.1 日志系统
```typescript
enum LogLevel {
  ERROR = 'error',
  WARN = 'warn',
  INFO = 'info',
  DEBUG = 'debug'
}

class Logger {
  static log(level: LogLevel, message: string, meta?: any) {
    // 日志记录逻辑
  }
}
```

### 8.2 监控指标
- **性能监控**: 响应时间、吞吐量
- **错误监控**: 错误率、异常统计
- **业务监控**: 用户活跃度、功能使用率
- **系统监控**: CPU、内存、磁盘使用率

## 9. 扩展性架构

### 9.1 水平扩展准备
- **无状态设计**: 服务无状态，便于负载均衡
- **数据库分离**: 读写分离准备
- **微服务预留**: 模块化设计，便于拆分

### 9.2 功能扩展
- **插件机制**: 预留插件接口
- **第三方集成**: 标准化API接口
- **多租户支持**: 数据隔离设计

### 9.3 技术栈升级
- **版本兼容**: 向后兼容设计
- **配置外部化**: 环境配置分离
- **容器化准备**: Docker部署支持

## 10. 部署架构

### 10.1 开发环境
```bash
# 前端开发服务器
npm run dev          # 端口: 3000

# 后端开发服务器  
npm run dev          # 端口: 8000

# 数据库
SQLite文件           # 本地文件
```

### 10.2 生产环境
```bash
# 前端静态文件
nginx服务            # 端口: 80

# 后端服务
PM2进程管理          # 端口: 8000

# 数据库
SQLite文件 + 备份策略
```

### 10.3 CI/CD流程
```
代码提交 → 自动构建 → 自动测试 → 部署到测试环境 → 人工验证 → 部署到生产环境
```

## 11. 技术债务和优化计划

### 11.1 短期优化
- 完善单元测试覆盖率
- 优化数据库查询性能
- 增强错误处理机制

### 11.2 中期优化
- 引入Redis缓存
- 实现分布式部署
- 添加监控告警系统

### 11.3 长期规划
- 微服务架构改造
- 大数据分析能力
- AI智能推荐功能