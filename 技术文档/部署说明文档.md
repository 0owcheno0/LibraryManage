# 团队知识库管理工具 - 部署说明文档

## 1. 部署概述

### 1.1 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Node.js**: 16.x 或以上版本
- **npm**: 8.x 或以上版本
- **内存**: 最低 4GB，推荐 8GB
- **磁盘空间**: 最低 10GB 可用空间
- **网络**: 需要互联网连接（用于依赖下载）

### 1.2 部署架构
```
┌─────────────────────────────────────────────────────┐
│                   生产环境                          │
│                                                     │
│  ┌─────────────┐    ┌─────────────┐               │
│  │    前端      │    │    后端      │               │
│  │   端口:80    │    │  端口:8000   │               │
│  │   (Nginx)   │────│  (Node.js)  │               │
│  └─────────────┘    └─────────────┘               │
│                            │                        │
│                     ┌─────────────┐               │
│                     │   SQLite    │               │
│                     │    数据库    │               │
│                     └─────────────┘               │
│                                                     │
│  ┌─────────────────────────────────────────────────┐ │
│  │              文件存储系统                        │ │
│  │    /uploads/{documents,thumbnails,avatars}     │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

## 2. 环境准备

### 2.1 安装 Node.js 和 npm
#### Windows
1. 访问 [Node.js官网](https://nodejs.org/) 下载 LTS 版本
2. 运行安装程序，按默认设置安装
3. 打开命令提示符，验证安装：
```bash
node --version
npm --version
```

#### macOS
```bash
# 使用 Homebrew 安装
brew install node

# 验证安装
node --version
npm --version
```

#### Ubuntu/Debian
```bash
# 更新包索引
sudo apt update

# 安装 Node.js 和 npm
sudo apt install nodejs npm

# 验证安装
node --version
npm --version
```

### 2.2 安装 Git（可选）
```bash
# Windows: 下载并安装 Git for Windows
# macOS: 
brew install git

# Ubuntu/Debian:
sudo apt install git
```

## 3. 项目获取和初始化

### 3.1 下载项目代码
```bash
# 如果使用 Git
git clone <repository_url>
cd knowledge-base-management

# 或者直接下载压缩包并解压
```

### 3.2 项目目录结构
```
knowledge-base-management/
├── frontend/                 # 前端项目目录
├── backend/                  # 后端项目目录
├── database/                 # 数据库文件目录
├── docs/                     # 项目文档
├── scripts/                  # 部署脚本
│   ├── setup.sh             # Linux/macOS 安装脚本
│   ├── setup.bat            # Windows 安装脚本
│   └── deploy.sh            # 部署脚本
└── README.md
```

## 4. 开发环境部署

### 4.1 快速启动脚本

#### Linux/macOS
```bash
# 给脚本执行权限
chmod +x scripts/setup.sh

# 运行安装脚本
./scripts/setup.sh

# 启动开发环境
npm run dev
```

#### Windows
```batch
# 运行安装脚本
scripts\setup.bat

# 启动开发环境
npm run dev
```

### 4.2 手动安装步骤

#### 4.2.1 安装后端依赖
```bash
cd backend
npm install
```

#### 4.2.2 配置后端环境变量
创建 `backend/.env` 文件：
```env
# 服务器配置
PORT=8000
NODE_ENV=development

# JWT 配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=2h
JWT_REFRESH_EXPIRES_IN=7d

# 数据库配置
DB_PATH=../database/knowledge_base.db

# 文件上传配置
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=104857600
ALLOWED_FILE_TYPES=pdf,doc,docx,xls,xlsx,ppt,pptx,txt,jpg,png,gif

# 日志配置
LOG_LEVEL=info
LOG_FILE=./logs/app.log
```

#### 4.2.3 初始化数据库
```bash
cd backend
npm run db:init
```

#### 4.2.4 启动后端服务
```bash
cd backend
npm run dev
```

#### 4.2.5 安装前端依赖
```bash
cd frontend
npm install
```

#### 4.2.6 配置前端环境变量
创建 `frontend/.env` 文件：
```env
# API 配置
VITE_API_BASE_URL=http://localhost:8000/api/v1

# 应用配置
VITE_APP_TITLE=团队知识库管理工具
VITE_APP_VERSION=1.0.0

# 开发配置
VITE_DEV_PORT=3000
```

#### 4.2.7 启动前端服务
```bash
cd frontend
npm run dev
```

### 4.3 验证开发环境
访问 `http://localhost:3000`，确保应用正常运行。

## 5. 生产环境部署

### 5.1 生产环境准备

#### 5.1.1 创建部署目录
```bash
sudo mkdir -p /opt/knowledge-base
sudo chown $USER:$USER /opt/knowledge-base
cd /opt/knowledge-base
```

#### 5.1.2 安装 PM2（进程管理器）
```bash
npm install -g pm2
```

#### 5.1.3 安装 Nginx（可选）
```bash
# Ubuntu/Debian
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx

# macOS
brew install nginx
```

### 5.2 后端生产部署

#### 5.2.1 构建后端
```bash
cd backend
npm run build
```

#### 5.2.2 配置生产环境变量
创建 `backend/.env.production` 文件：
```env
# 服务器配置
PORT=8000
NODE_ENV=production

# JWT 配置
JWT_SECRET=your_production_jwt_secret_key_here
JWT_EXPIRES_IN=2h
JWT_REFRESH_EXPIRES_IN=7d

# 数据库配置
DB_PATH=/opt/knowledge-base/database/knowledge_base.db

# 文件上传配置
UPLOAD_PATH=/opt/knowledge-base/uploads
MAX_FILE_SIZE=104857600
ALLOWED_FILE_TYPES=pdf,doc,docx,xls,xlsx,ppt,pptx,txt,jpg,png,gif

# 日志配置
LOG_LEVEL=info
LOG_FILE=/opt/knowledge-base/logs/app.log

# CORS 配置
CORS_ORIGIN=https://yourdomain.com
```

#### 5.2.3 PM2 配置文件
创建 `backend/ecosystem.config.js` 文件：
```javascript
module.exports = {
  apps: [{
    name: 'knowledge-base-api',
    script: './dist/app.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development'
    },
    env_production: {
      NODE_ENV: 'production'
    },
    log_file: '/opt/knowledge-base/logs/combined.log',
    out_file: '/opt/knowledge-base/logs/out.log',
    error_file: '/opt/knowledge-base/logs/error.log',
    max_memory_restart: '1G',
    watch: false,
    autorestart: true
  }]
};
```

#### 5.2.4 启动后端服务
```bash
cd backend
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup
```

### 5.3 前端生产部署

#### 5.3.1 构建前端
```bash
cd frontend
npm run build
```

#### 5.3.2 配置 Nginx
创建 `/etc/nginx/sites-available/knowledge-base` 文件：
```nginx
server {
    listen 80;
    server_name yourdomain.com;  # 替换为你的域名

    root /opt/knowledge-base/frontend/dist;
    index index.html;

    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API 请求代理到后端
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 文件上传和下载
    location /uploads/ {
        alias /opt/knowledge-base/uploads/;
        expires 1y;
        add_header Cache-Control "public";
    }

    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
}
```

#### 5.3.3 启用 Nginx 配置
```bash
sudo ln -s /etc/nginx/sites-available/knowledge-base /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5.4 HTTPS 配置（可选）

#### 5.4.1 安装 Certbot
```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx
```

#### 5.4.2 获取 SSL 证书
```bash
sudo certbot --nginx -d yourdomain.com
```

## 6. 数据库部署和维护

### 6.1 数据库初始化
```bash
cd backend
npm run db:init
```

### 6.2 数据库备份脚本
创建 `scripts/backup.sh` 文件：
```bash
#!/bin/bash

# 配置
DB_PATH="/opt/knowledge-base/database/knowledge_base.db"
BACKUP_DIR="/opt/knowledge-base/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/knowledge_base_$DATE.db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
cp $DB_PATH $BACKUP_FILE

# 压缩备份
gzip $BACKUP_FILE

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "Database backup completed: $BACKUP_FILE.gz"
```

### 6.3 自动备份配置
```bash
# 添加到 crontab
crontab -e

# 每天凌晨 2 点自动备份
0 2 * * * /opt/knowledge-base/scripts/backup.sh
```

## 7. 监控和日志

### 7.1 PM2 监控
```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs knowledge-base-api

# 监控资源使用
pm2 monit
```

### 7.2 日志轮转配置
创建 `/etc/logrotate.d/knowledge-base` 文件：
```
/opt/knowledge-base/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        pm2 reload knowledge-base-api
    endscript
}
```

### 7.3 系统监控脚本
创建 `scripts/monitor.sh` 文件：
```bash
#!/bin/bash

# 检查后端服务
if ! pm2 list | grep -q "knowledge-base-api.*online"; then
    echo "Backend service is down, restarting..."
    pm2 restart knowledge-base-api
fi

# 检查 Nginx
if ! systemctl is-active --quiet nginx; then
    echo "Nginx is down, restarting..."
    sudo systemctl restart nginx
fi

# 检查磁盘空间
DISK_USAGE=$(df /opt/knowledge-base | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Warning: Disk usage is ${DISK_USAGE}%"
fi
```

## 8. 安全配置

### 8.1 防火墙配置
```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 8.2 文件权限配置
```bash
# 设置应用目录权限
sudo chown -R www-data:www-data /opt/knowledge-base
sudo chmod -R 755 /opt/knowledge-base

# 设置上传目录权限
sudo chmod -R 755 /opt/knowledge-base/uploads

# 设置数据库文件权限
sudo chmod 644 /opt/knowledge-base/database/knowledge_base.db
```

### 8.3 系统用户配置
```bash
# 创建专用用户
sudo useradd -r -s /bin/false knowledge-base

# 修改文件所有者
sudo chown -R knowledge-base:knowledge-base /opt/knowledge-base
```

## 9. 性能优化

### 9.1 Nginx 性能优化
在 Nginx 配置中添加：
```nginx
# 工作进程数
worker_processes auto;

# 连接数优化
events {
    worker_connections 1024;
    use epoll;
}

# 缓冲区优化
client_body_buffer_size 16K;
client_header_buffer_size 1k;
client_max_body_size 100M;
large_client_header_buffers 2 1k;
```

### 9.2 Node.js 性能优化
在 PM2 配置中：
```javascript
{
  max_memory_restart: '1G',
  node_args: '--max-old-space-size=1024'
}
```

## 10. 故障排除

### 10.1 常见问题

#### 问题1: 端口被占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep :8000

# 杀死占用进程
sudo kill -9 <PID>
```

#### 问题2: 权限错误
```bash
# 修复文件权限
sudo chown -R $USER:$USER /opt/knowledge-base
sudo chmod -R 755 /opt/knowledge-base
```

#### 问题3: 数据库连接失败
```bash
# 检查数据库文件是否存在
ls -la /opt/knowledge-base/database/

# 重新初始化数据库
cd backend && npm run db:init
```

#### 问题4: 前端白屏
1. 检查 API 地址配置
2. 查看浏览器控制台错误
3. 检查 Nginx 配置

### 10.2 日志查看
```bash
# 查看应用日志
pm2 logs

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log

# 查看系统日志
sudo journalctl -u nginx -f
```

## 11. 升级和维护

### 11.1 应用升级流程
```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 停止服务
pm2 stop knowledge-base-api

# 3. 更新代码
git pull origin main

# 4. 更新依赖
cd backend && npm install
cd frontend && npm install

# 5. 重新构建
cd backend && npm run build
cd frontend && npm run build

# 6. 启动服务
pm2 start knowledge-base-api
```

### 11.2 定期维护任务
```bash
# 清理旧日志
find /opt/knowledge-base/logs -name "*.log" -mtime +30 -delete

# 优化数据库
sqlite3 /opt/knowledge-base/database/knowledge_base.db "VACUUM;"

# 更新系统包
sudo apt update && sudo apt upgrade
```

## 12. 卸载说明

### 12.1 完全卸载
```bash
# 停止服务
pm2 stop knowledge-base-api
pm2 delete knowledge-base-api

# 移除 Nginx 配置
sudo rm /etc/nginx/sites-enabled/knowledge-base
sudo rm /etc/nginx/sites-available/knowledge-base
sudo systemctl reload nginx

# 删除应用文件
sudo rm -rf /opt/knowledge-base

# 删除系统用户
sudo userdel knowledge-base
```

## 13. 附录

### 13.1 常用命令速查
```bash
# 启动开发环境
npm run dev

# 构建生产版本
npm run build

# PM2 管理
pm2 start/stop/restart/delete <app_name>
pm2 logs <app_name>
pm2 monit

# Nginx 管理
sudo systemctl start/stop/restart/reload nginx
sudo nginx -t

# 数据库操作
npm run db:init
npm run db:backup
npm run db:restore
```

### 13.2 配置文件模板
所有配置文件模板都可以在 `templates/` 目录中找到。

### 13.3 技术支持
- 项目文档: `/docs`
- 问题反馈: 项目 Issues
- 邮件支持: support@example.com