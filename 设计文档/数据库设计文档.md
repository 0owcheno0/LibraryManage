# 团队知识库管理工具 - 数据库设计文档

## 1. 数据库概述

### 1.1 数据库选型
- **数据库**: SQLite
- **版本**: 3.x
- **特点**: 轻量级、无服务器、零配置、支持事务

### 1.2 设计原则
- 数据完整性保证
- 适当的范式设计
- 合理的索引策略
- 支持并发访问
- 便于备份和恢复

## 2. 数据库实体关系图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    users    │       │ user_roles  │       │    roles    │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │◄─────►│ user_id(FK) │◄─────►│ id (PK)     │
│ username    │       │ role_id(FK) │       │ name        │
│ email       │       │ created_at  │       │ description │
│ password    │       └─────────────┘       │ permissions │
│ created_at  │                             └─────────────┘
│ updated_at  │                                     │
└─────────────┘                                     │
       │                                            │
       │                                            │
       ▼                                            ▼
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│  documents  │       │document_tags│       │    tags     │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │◄─────►│document_id  │◄─────►│ id (PK)     │
│ title       │       │ tag_id (FK) │       │ name        │
│ file_name   │       │ created_at  │       │ color       │
│ file_path   │       └─────────────┘       │ description │
│ file_size   │                             │ created_by  │
│ mime_type   │                             │ created_at  │
│ description │                             └─────────────┘
│ created_by  │
│ created_at  │
│ updated_at  │
└─────────────┘
       │
       ▼
┌─────────────┐       ┌─────────────┐
│  comments   │       │permissions  │
├─────────────┤       ├─────────────┤
│ id (PK)     │       │ id (PK)     │
│document_id  │       │ user_id(FK) │
│ user_id(FK) │       │document_id  │
│ content     │       │ permission  │
│ created_at  │       │ granted_by  │
│ updated_at  │       │ created_at  │
└─────────────┘       └─────────────┘
```

## 3. 数据表设计

### 3.1 用户表 (users)
存储系统用户基本信息

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    avatar_path VARCHAR(255),
    is_active BOOLEAN DEFAULT 1,
    last_login_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**:
- `id`: 用户唯一标识
- `username`: 用户名，唯一
- `email`: 邮箱地址，唯一
- `password_hash`: 密码哈希值
- `full_name`: 用户全名
- `avatar_path`: 头像文件路径
- `is_active`: 账户是否激活
- `last_login_at`: 最后登录时间

### 3.2 角色表 (roles)
定义系统角色和权限

```sql
CREATE TABLE roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    permissions TEXT, -- JSON格式存储权限列表
    is_system BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**预设角色数据**:
```sql
INSERT INTO roles (name, description, permissions, is_system) VALUES
('admin', '系统管理员', '["all"]', 1),
('editor', '编辑者', '["read", "write", "upload", "tag"]', 1),
('viewer', '查看者', '["read"]', 1);
```

### 3.3 用户角色关联表 (user_roles)
用户和角色的多对多关系

```sql
CREATE TABLE user_roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    assigned_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_by) REFERENCES users(id),
    UNIQUE(user_id, role_id)
);
```

### 3.4 文档表 (documents)
存储文档基本信息

```sql
CREATE TABLE documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(100),
    file_hash VARCHAR(64), -- 文件MD5哈希，防重复
    thumbnail_path VARCHAR(255), -- 缩略图路径
    download_count INTEGER DEFAULT 0,
    view_count INTEGER DEFAULT 0,
    is_public BOOLEAN DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active', -- active, archived, deleted
    created_by INTEGER NOT NULL,
    updated_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id)
);
```

**字段说明**:
- `title`: 文档标题
- `file_hash`: 文件哈希值，用于去重
- `thumbnail_path`: 缩略图路径
- `download_count`: 下载次数
- `view_count`: 查看次数
- `is_public`: 是否公开
- `status`: 文档状态

### 3.5 标签表 (tags)
管理文档标签

```sql
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL,
    color VARCHAR(7) DEFAULT '#1890ff', -- 十六进制颜色值
    description TEXT,
    parent_id INTEGER, -- 支持标签层级
    usage_count INTEGER DEFAULT 0,
    created_by INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES tags(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 3.6 文档标签关联表 (document_tags)
文档和标签的多对多关系

```sql
CREATE TABLE document_tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_by INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id),
    UNIQUE(document_id, tag_id)
);
```

### 3.7 权限表 (permissions)
细粒度权限控制

```sql
CREATE TABLE permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    document_id INTEGER NOT NULL,
    permission_type VARCHAR(20) NOT NULL, -- read, write, delete, share
    granted_by INTEGER NOT NULL,
    expires_at DATETIME, -- 权限过期时间
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id),
    UNIQUE(user_id, document_id, permission_type)
);
```

### 3.8 评论表 (comments)
文档评论功能

```sql
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    parent_id INTEGER, -- 支持评论回复
    content TEXT NOT NULL,
    is_deleted BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (parent_id) REFERENCES comments(id)
);
```

### 3.9 系统配置表 (system_configs)
系统配置参数

```sql
CREATE TABLE system_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    updated_by INTEGER,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (updated_by) REFERENCES users(id)
);
```

### 3.10 操作日志表 (operation_logs)
记录用户操作日志

```sql
CREATE TABLE operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    action VARCHAR(50) NOT NULL, -- login, upload, download, delete, etc.
    resource_type VARCHAR(50), -- document, tag, user, etc.
    resource_id INTEGER,
    details TEXT, -- JSON格式详细信息
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## 4. 索引设计

### 4.1 主要索引
```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);

-- 文档表索引
CREATE INDEX idx_documents_title ON documents(title);
CREATE INDEX idx_documents_created_by ON documents(created_by);
CREATE INDEX idx_documents_status ON documents(status);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_file_hash ON documents(file_hash);

-- 标签表索引
CREATE INDEX idx_tags_name ON tags(name);
CREATE INDEX idx_tags_parent_id ON tags(parent_id);

-- 文档标签关联表索引
CREATE INDEX idx_document_tags_document_id ON document_tags(document_id);
CREATE INDEX idx_document_tags_tag_id ON document_tags(tag_id);

-- 权限表索引
CREATE INDEX idx_permissions_user_id ON permissions(user_id);
CREATE INDEX idx_permissions_document_id ON permissions(document_id);
CREATE INDEX idx_permissions_expires_at ON permissions(expires_at);

-- 评论表索引
CREATE INDEX idx_comments_document_id ON comments(document_id);
CREATE INDEX idx_comments_user_id ON comments(user_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);

-- 操作日志表索引
CREATE INDEX idx_operation_logs_user_id ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_action ON operation_logs(action);
CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at);
```

## 5. 数据完整性约束

### 5.1 外键约束
- 所有外键关系已在表结构中定义
- 使用CASCADE删除保证数据一致性
- 关键关联使用RESTRICT防止误删

### 5.2 检查约束
```sql
-- 文件大小检查
ALTER TABLE documents ADD CONSTRAINT chk_file_size 
CHECK (file_size > 0 AND file_size < 1073741824); -- 最大1GB

-- 权限类型检查
ALTER TABLE permissions ADD CONSTRAINT chk_permission_type 
CHECK (permission_type IN ('read', 'write', 'delete', 'share'));

-- 文档状态检查
ALTER TABLE documents ADD CONSTRAINT chk_status 
CHECK (status IN ('active', 'archived', 'deleted'));
```

## 6. 数据库初始化

### 6.1 创建数据库脚本 (init.sql)
```sql
-- 创建所有表结构
-- (包含上述所有CREATE TABLE语句)

-- 插入默认数据
INSERT INTO roles (name, description, permissions, is_system) VALUES
('admin', '系统管理员', '["all"]', 1),
('editor', '编辑者', '["read", "write", "upload", "tag"]', 1),
('viewer', '查看者', '["read"]', 1);

INSERT INTO system_configs (config_key, config_value, description) VALUES
('max_file_size', '104857600', '最大文件上传大小（字节）'),
('allowed_file_types', '["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","jpg","png","gif"]', '允许上传的文件类型'),
('system_name', '团队知识库管理系统', '系统名称');
```

## 7. 性能优化

### 7.1 查询优化
- 为常用查询字段建立索引
- 使用EXPLAIN分析查询计划
- 避免全表扫描
- 合理使用分页查询

### 7.2 数据维护
- 定期清理删除的记录
- 优化数据库文件(VACUUM)
- 更新统计信息(ANALYZE)
- 监控数据库大小

## 8. 备份与恢复

### 8.1 备份策略
- 每日自动备份数据库文件
- 保留最近30天的备份
- 重要操作前手动备份

### 8.2 恢复方案
- SQLite文件直接复制恢复
- 支持SQL脚本导入导出
- 数据迁移工具支持

## 9. 安全考虑

### 9.1 数据加密
- 密码使用bcrypt加密
- 敏感字段考虑加密存储
- 数据传输加密

### 9.2 权限控制
- 数据库访问权限控制
- SQL注入防护
- 输入数据验证

## 10. 数据字典

详细的数据字典包含每个表的完整字段说明、数据类型、约束条件、示例数据等信息，为开发和维护提供参考。